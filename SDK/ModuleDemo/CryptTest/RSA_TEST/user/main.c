/**
  ******************************************************************************
  * @file    3121Demo\ModuleDemo\CryptTest\RSA_TEST\user\main.c
  * @author  Yichip Application Team
  * @version V1.0.1
  * @date    15-July-2020
  * @brief   RSA TEST program.
  ******************************************************************************
  * @attention
  *
  * COPYRIGHT 2019 Yichip Microelectronics
  *
  * The purpose of this demo is to provide guidance to customers engaged in
  * programming work to guide them smoothly to product development,
  * so as to save their time.
  *
  * Therefore, Yichip microelectronics shall not be responsible for any direct,
  * indirect or consequential damages caused by any content of this demo
  * and/or contained in this code used by the customer in its products.
  *
  ******************************************************************************
  */

/* Includes ------------------------------------------------------------------*/
#include <string.h>
#include <stdio.h>
#include "yc3121.h"
#include "yc_gpio.h"
#include "yc_uart.h"
#include "yc_rsa.h"
#include "yc_rand.h"
#include "yc_calc.h"
#include "board_config.h"

/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/
#define PLAIN "1234567890"

#define KEY_LEN_1024		1024 / 32
#define RSA_N_1024			"CDE42E9228172CBE4C542194BBB112728E0180FF7196B849D74F0630ED92AA5C4E04224E10C43881EBD710151E1F6BE47B2F688EAB880AC3D876C9702378CB524CA85637DE795D4393D129672DB4655C1EE82959ED051A92C1902135751CC4EC3E5B9050D5DF7A40610F61E382D864CC85F49F676E7C58A56E275D32648A65AB"
#define RSA_E_1024			"010001"
#define RSA_D_1024			"B5C1ED76EB5B620D709688BAA362F3351BB5AA2A571D45FD31CCBA5B712F1BA3B6DFA165271A020477AD78AE1BD4834BC58F998EF1507CA85DACA7B18E2EF1D5548723BD59DF8DA9B108DA2B5A455E9F3F12CD2DC0E549FF3EA534E0690AA393042062290931FA2B5AC1E9A1753C4791D74641103AFF067F7DD86B02C768CC59"
#define RSA_P_1024			"F2DEB75C74A29F4FB17405ED8B584E63839F1822029FADB86AB4AAEA5E76E915503BB6C44BCE3194026FFF47170D3725AEC18B99348DB40B6B5522FAB81CE3A7"
#define RSA_Q_1024			"D905AFCF9AEEDAE746550927BA6B3C8A32EDEE8C16DC8306027FF54C159CBC847DF4FD4841FFF57E50E8A675C9CAC2428C2BD75B00B7BA74243F3898DBF4FE5D"
#define RSA_DP_1024			"4A1B14FDDC04E6F16D2706CC0591AB51880EDA513E55B4AF29B7F8D2CC8221FAC3E18491FEC36AB34BCF1AA8796B29E190A233D34A8AD65E09A10FAC4AD35DCF"
#define RSA_DQ_1024			"06CB8AC9B14C314674894D14155E2E33158D259EF5484A41F1EA17C01E1D1E39F7C7A7F68F3A7871500F38C70F5E6DDEAF8CDFDD55946B1E1FD46AED3E55D971"
#define RSA_QP_1024			"7E4BDC3E7FA115F1AEFD49CE2FFA474E4777FFA5195A6909919DD093CFACDC98A13C72EFA2476F148E6BE7F330E4143BEDF8B9D965D3A3A2657890049DE98635"
#define RSA_N_C_1024		"64EFEDD782B6A49AEA1872EDD9275E49931139CCFF5AC92433B07B0A9EA6693FA7C9D1B3149E17C8DD0A1AB8548844EB6E0F50DC894AF0593E4E5B7E27690FB576642F98A1A33C22FF382DAFAEAECDFFDDFD3DD09A207C5B335DEC99C5D137426421E044312602DA6901A218EAB977D6A5C7B5A60191A4BDE0DBC63C407FEF8D"
#define RSA_P_C_1024		"5DA1CD5FA89C67FA7728E97B67BAAE72D1A9F03E7CC032ADB9EDAC3949667F4B04A1196D73F5D8A375B9E7E13A95D7F934ABB508EC96DE712644621864CB94B8"
#define RSA_Q_C_1024		"4017B2E1F5500979E663ECE3A049678E49BCD4C822BE2E2C6C6C815A2EC23F5EEE7C153C6A2C2677F2419792F2BA6BE8B4C42943267922BF02B02AAAE7071E23"
#define RSA_N_Q_1024		"85BA92FD"
#define RSA_P_Q_1024		"3AC26BE9"
#define RSA_Q_Q_1024		"98B83A0B"
#define CIPHER_1024			"4257A706BDB0F1AEF8957E5B00ADB1BB2386AAC79394180049AF03C5AE12642E20D33D725408E361FBB600871E0AD925DAB6AA76CE6324E9189B33C99106BA45317FD8639EAF2F6DCA03DEA33D0DCE37D9493F917A1DB8A47F4FC249D44B22775D12908BE2F8F95A8451A0738A9961BD4E905741AB6A16EA2D600A5BB95AF399"

#define KEY_LEN_2048		2048 / 32
#define RSA_N_2048			"75A18418B8EB30CD990303626314215772406FB53C90BC34F8963643CB7C86655174E82AC581EA9D93FBCD8B9B9623E9FE8AD5E2F9311C8FEEFB709D78CC961DC49A3CA5F55733E68A10563695782DE1C8BE5F031E84540E14AA369FA8E03D03CCC7E02B2A030C44AF4B989DBC99640BB4925B9C3AAE287C241C1AF133502AD61593C62FAB42604680FBE1EC77C98B68008C15E52C24035A8F220C1B944C547F1E0FA4C6475395839536FD286F23063E802D657C6D176B46E3B1862616D32EADB0DC1C1AF83EAF33640224658BB46052ACD8D8876A7F35A9232ED4AD2E15FD958F294A5BFFBA11E2E18F7D3377136F6C91B93C9656E289E19FE3E928FDF7FB7F"
#define RSA_E_2048			"10001"
#define RSA_D_2048			"562B23211914F0832B7B5197590CFDFF98EA2AEA909B55C357F67179E82E2825402E6B84297AA9EB14E47805B4CB9F33620B41F32AA8174C38BC681A72CB2B8C52E0C95CA9046038991AAE8CFDA133BB19DA9AAF2643B96F3724192F8BFDF7B438E692080C967EFE318B27192577181A9B043BA78E34D5E35A705C2C2472AD6D762273180C7DA3107658259BC5BF554B3CC2CF33F264DDB3C45406A047A1B3720A655CAFF677FA7DCFDB9F125A8C1D333E07F93C884AFC7E9444D6033AAB3975DED23BC71BCA3EC83CCF000D6586020B1BF483762BFE6F1C64CE021CB85AD538A18B7539D42619C6901364ED6B14D07EC9EFECA16AC59D5BAB0F8840A5D86281"
#define RSA_P_2048			"9AA3212A0A6E3158E399844D2F44C9CC3D25D5DDF1C18B2F49E70BB2326F1E738C33DFB87A4DAC5EED914F72724C670D393D1B7368D2006DA1A649E5D03930C239F0A304C04F3222787436A271D544F8BD3DD3A3C2032B84C68B9080B600AE57395146C6F46C18DA1DB9129544D8B9C65F9DD624164A64AB500EB83AFDBDF279"
#define RSA_Q_2048			"C2BC8CFDC7F5C23DE47E95D39BD0EE16B27957280655ED4F0D0C8793AACD279B374BA0C3CFF78781DA7D5EF8DE83FDDB83A04386E599FC5A20E113571852FBFE88275A684C3BF6A1F187E3497DD8EC6B7ACE419F471C615DA1FD48A36EF4DBC9CBC692A258BB67D6C213FD7D8FC513FE307E2A2943D7739227D7FD2EC4AB1FB7"
#define RSA_DP_2048			"598E6E4F8DB8E1A56C32E5775A0FC99B1A32C6588281A79D1C7CCDBE470D29A29BA9134120BBC93F34F0FA04FB031A8F82FDCBDF1BEEBB46C2DEAE5F85270A01025345E62385FA301278A38792CB83E5569BEEED21187AE4ABA3FA6D407AC67D4779B5B6D5A9A0FEF945CCE85BF5F4295A08EC12FC41DB6987B4EEA7637AD569"
#define RSA_DQ_2048			"9B8767BBD096317AA921889C271828EFABBF49A2C7DC9CD9C3FC3BD3EE5847C7A9D417240CD70F3CE0B9BCBE5B4963D88C39D574C9AFC062635C1FCC31BB2553D67E47B081226B0A50134DAE067AD7E7C77F2FDDFC37687415CA6AD74CE8F719264D0413F1764BAAB3FAAF3C37351990AC3E37821992DBD4E1499A065E40A5E5"
#define RSA_QP_2048			"906598444A1664A4F3FD0E67DA92E0BCBB445101DC09ED567ACE2D49DBEC61B2E06ECD64544B0C35D26E68DBE3048B83A601285245AF4FFC94E3EF5F7602E3EC9B8AD6D9FBC518F95D3A638D7A3FC34E72307F67A48C0696753664D589BE2EC861EB659C7AB06C5A9095E4D8794D49504E651EAEE26C76091175C5B7082B4016"
#define RSA_N_C_2048		"65B37280142A48FCED5C720FC0A17DB2A6B6C1901CD1FECA252FEB61E5CF58E4068800EE4F54D2D9E35566BC5CB976B497E65FFA529F398E562BB38AE891A03B212D88E98073DE85A5A00D9B2CA11D0B14AF22CD2C832FD8DCD5E4ADC6BA95FFC7FBEBC80FE9D32ACB4EB6F52C742B11F11D83655E30B5FC786E15CC8C8D1C9F9EF66284D337B8A697E4F8485064D28823FD0DB4E75F5618437D776D6910405AB88B467F2E5DD4C206C670807E25227E61D02EE32B37C731DA1DF141D36CC48B636867C37C6A08C17EE8416A0A33A0791EE2233C3915EC38B2DA1984DE95F00BEAA1575DBD1ACCF4F8DB37500656BE4CD7A874F6247A127C2F32A046197D4D2A"
#define RSA_P_C_2048		"0224D929A1397374039926557BCA9FC74DD9E7AB3DBAF1A216DC1E57ED4F57B1A7D6E922F3CB5FE825FA14264BBFA864FD6129885EABC7C21680C2390511AC7189EF4F7F7BDEA690843353C18235E9E56BA985F712D44B377AE1578321A61DFAB7240E12597A5513B055E455BBAA66BCD25AAB72129D830B6EFAFFBBA5D30132"
#define RSA_Q_C_2048		"5AD49E385E01DBA437ED91437ED4C9C17E1EE4F5EACABF9624C3C8AF4B4712D35900C84522FADC41D5723AA652D33F2F25DB60112F8DE2D9F907E8EE7B4A84129AA9FFCEF7FA1FFB4E4E879C5D55CFD45757AAC16739C495D5C756BFA4C3DEF9A591962919C298495A9727252B345D9470C4BFA33F5121AA861952B0D4A3A3D9"
#define RSA_N_Q_2048		"FAEC3B81"
#define RSA_P_Q_2048		"7D3E2837"
#define RSA_Q_Q_2048		"552511F9"
#define CIPHER_2048			"1A489B964931E96ECBED9DB0A357B0912C203B3020BA1427353AD06CAD229A77F9E864A11BF0AD6A4FE2CB88D3C0F4AE0B964C6122DA581E2E509D9B7828E41BDDC6A179F43EF2B1DAB09C4D49ACCE3CD55FBFA256E264189C365A2E8BE9640B98A73267E9A5ACBD9C93838AD76ED57DCD8C680F248CAC97CDA034CC348A5754EBFAAA3A855FF618CE6BCA51BCBAC33D105D0F6BF58FE1C0E7F8DF4CB293D48A4EC5FEA617DFA00F1E6688893FCF5DC7B45DE3C511E14DF2D6D072511664BF397D322DD61952882CE88E8F1D770B14340B52AAA2D2A388BF2A1F6A5D7A13EF149FF9AEDFE0A2657DCB9568A06FBFFB800D1CFB7CA625630D8DA39174008F93F9"

/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
/* Private function prototypes -----------------------------------------------*/
void UART_Configuration(void);
void test_rsa_self(void);
int bn_read_string_to_bytes(uint8_t *r, uint32_t len, const char *s);

/**
  * @brief  Main program
  * @param  None
  * @retval None
  */
int main(void)
{
    UART_Configuration();

    MyPrintf("Yichip Yc3121 RSA test Demo V1.0.\r\n");

    test_rsa_self();

    while (1)
    {

    }
}

/**
  * @brief  Serial port 0 initialization function.
  * @param  None
  * @retval None
  */
void UART_Configuration(void)
{
    UART_InitTypeDef UART_InitStruct;

    /* Configure serial ports RX and TX for IO. */
    GPIO_Config(UART0_TX_PORT, UART0_TX_PIN, UART0_TXD);
    GPIO_Config(UART0_RX_PORT, UART0_RX_PIN, UART0_RXD);

    /* USARTx configured as follow:
    - BaudRate = 115200 baud
    - Word Length = 8 Bits
    - Stop Bit = 1 Stop Bit
    - Parity = No Parity
    - Hardware flow control disabled (RTS and CTS signals)
    - Receive and transmit enabled
    */
    UART_InitStruct.BaudRate = UARTBAUD;			//Configure serial port baud rate, the baud rate defaults to 128000.
    UART_InitStruct.DataBits = Databits_8b;
    UART_InitStruct.StopBits = StopBits_1;
    UART_InitStruct.Parity = Parity_None;
    UART_InitStruct.FlowCtrl = FlowCtrl_None;
    UART_InitStruct.Mode = Mode_duplex;

    UART_Init(UART0, &UART_InitStruct);
}

void test_rsa_self(void)
{
    RSA_PrivateKeyTypeDef pri_key;
    RSA_PublicKeyTypeDef pub_key;

    uint32_t ret;
    uint8_t plain[2048 / 8];
    uint8_t cipher[2048 / 8];
    uint8_t tmp0[2048 / 8];

    MyPrintf("\n*************RSA 1024 Test In*************\n");
    pri_key.bytes = 1024 / 8; //密钥bit长度
    bn_read_string_to_bytes(pri_key.e, 4, RSA_E_1024);
    bn_read_string_to_bytes(pri_key.p, pri_key.bytes / 2, RSA_P_1024);
    bn_read_string_to_bytes(pri_key.q, pri_key.bytes / 2, RSA_Q_1024);
    memcpy_r(pri_key.e, pri_key.e, 4);
    memcpy_r(pri_key.p, pri_key.p, pri_key.bytes / 2);
    memcpy_r(pri_key.q, pri_key.q, pri_key.bytes / 2);
    ret = RSA_CompleteKey_e(&pri_key, &RAND_RandP, NULL);

    MyPrintf("ret: %x", ret);

    pub_key.bytes = pri_key.bytes;
    memcpy(pub_key.e, pri_key.e, sizeof(pri_key.e));
    memcpy(pub_key.n, pri_key.n, sizeof(pri_key.n));
    memcpy(pub_key.n_c, pri_key.n_c, sizeof(pri_key.n_c));
    memcpy(pub_key.n_q, pri_key.n_q, sizeof(pri_key.n_q));

    bn_read_string_to_bytes(plain, pri_key.bytes, PLAIN);
    bn_read_string_to_bytes(cipher, pri_key.bytes, CIPHER_1024);
    memcpy_r(plain, plain, 128);
    memcpy_r(cipher, cipher, 128);

    memset(tmp0, 0, pri_key.bytes);
    RSA_Public(tmp0, plain, &pub_key, &RAND_RandP, NULL);
    MyPrintf("\r\nRSA_public test:%2x\n", (0 == memcmp(tmp0, cipher, pri_key.bytes)));

    memset(tmp0, 0, pri_key.bytes);
    RSA_Private_crt(tmp0, cipher, &pri_key, &RAND_RandP, NULL);
    MyPrintf("\r\nRSA_private_crt test:%2x\n", (0 == memcmp(tmp0, plain, pri_key.bytes)));

    MyPrintf("\n*************RSA 2048 Test In*************\n");
    pri_key.bytes = 2048 / 8; //密钥bit长度
    bn_read_string_to_bytes(pri_key.e, 4, RSA_E_2048);
    bn_read_string_to_bytes(pri_key.p, pri_key.bytes / 2, RSA_P_2048);
    bn_read_string_to_bytes(pri_key.q, pri_key.bytes / 2, RSA_Q_2048);
    memcpy_r(pri_key.e, pri_key.e, 4);
    memcpy_r(pri_key.p, pri_key.p, pri_key.bytes / 2);
    memcpy_r(pri_key.q, pri_key.q, pri_key.bytes / 2);
    ret = RSA_CompleteKey_e(&pri_key, &RAND_RandP, NULL);

    MyPrintf("ret: %x", ret);

    pub_key.bytes = pri_key.bytes;
    memcpy(pub_key.e, pri_key.e, sizeof(pri_key.e));
    memcpy(pub_key.n, pri_key.n, sizeof(pri_key.n));
    memcpy(pub_key.n_c, pri_key.n_c, sizeof(pri_key.n_c));
    memcpy(pub_key.n_q, pri_key.n_q, sizeof(pri_key.n_q));

    bn_read_string_to_bytes(plain, pri_key.bytes, PLAIN);
    bn_read_string_to_bytes(cipher, pri_key.bytes, CIPHER_2048);
    memcpy_r(plain, plain, 256);
    memcpy_r(cipher, cipher, 256);

    memset(tmp0, 0, pri_key.bytes);
    RSA_Public(tmp0, plain, &pub_key, &RAND_RandP, NULL);
    MyPrintf("\r\nRSA_public test:%2x\n", (0 == memcmp(tmp0, cipher, pri_key.bytes)));

    memset(tmp0, 0, pri_key.bytes);
    RSA_Private_crt(tmp0, cipher, &pri_key, &RAND_RandP, NULL);
    MyPrintf("\r\nRSA_private_crt test:%2x\n", (0 == memcmp(tmp0, plain, pri_key.bytes)));
}

/*
 * Import from an ASCII string to an big endian data array
 */

static int bn_get_digit(uint32_t *d, char c)
{
    *d = 255;

    if (c >= 0x30 && c <= 0x39) *d = c - 0x30;
    if (c >= 0x41 && c <= 0x46) *d = c - 0x37;
    if (c >= 0x61 && c <= 0x66) *d = c - 0x57;

    if (*d >= (uint32_t) 16)
        return (-1);

    return (0);
}

int bn_read_string_to_bytes(uint8_t *r, uint32_t len, const char *s)
{
    uint32_t i, j, slen;
    uint32_t d;

    slen = strlen(s);

    if ((len * 2) < slen)
        return (-1);

    memset(r, 0, len);

    len = len - 1;

    for (i = slen, j = 0; i > 0; i--, j++)
    {
        if (-1 == bn_get_digit(&d, s[i - 1]))
            return (-1);
        r[len - j / 2] |= d << ((j % 2) << 2);
    }

    return (0);
}

/************************ (C) COPYRIGHT Yichip Microelectronics *****END OF FILE****/
